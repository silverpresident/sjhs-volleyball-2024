@model VolleyballRallyManager.App.Areas.Admin.Models.MatchScorerViewModel

@{
    ViewData["Title"] = "Match Scorer";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    body { overflow-x: hidden; }
    .scorer-container { min-height: 100vh; padding: 20px; }
    .team-panel { 
        background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    }
    .away-panel {
        background: linear-gradient(135deg, #f9a825 0%, #fdd835 100%);
    }
    .team-name { font-size: 2rem; font-weight: bold; margin-bottom: 10px; }
    .team-score { 
        font-size: 6rem; 
        font-weight: bold; 
        margin: 20px 0;
        text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
    }
    .score-btn { 
        width: 80px;
        height: 80px;
        font-size: 2.5rem;
        border-radius: 50%;
        margin: 10px;
        font-weight: bold;
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .center-controls {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    .set-label {
        font-size: 2rem;
        font-weight: bold;
        color: #2e7d32;
        margin-bottom: 20px;
    }
    .set-control-btn {
        width: 100%;
        margin: 10px 0;
        padding: 15px;
        font-size: 1.1rem;
        font-weight: bold;
    }
    .sets-won-display {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
    }
    .set-box {
        width: 60px;
        height: 60px;
        border: 3px solid #ddd;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: bold;
    }
    .set-box.home { background: #4caf50; color: white; border-color: #2e7d32; }
    .set-box.away { background: #fdd835; color: #333; border-color: #f9a825; }
    .set-history {
        background: #f5f5f5;
        padding: 15px;
        border-radius: 8px;
        margin-top: 20px;
    }
    .set-history-item {
        padding: 8px;
        border-bottom: 1px solid #ddd;
        font-size: 1.1rem;
    }
    .quick-actions {
        background: #263238;
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
    }
    .quick-action-btn {
        width: 100%;
        margin: 5px 0;
        padding: 12px;
        font-weight: bold;
    }
    .update-feed {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        max-height: 90vh;
        overflow-y: auto;
    }
    .update-item {
        padding: 12px;
        border-left: 4px solid #2e7d32;
        background: #f5f5f5;
        margin-bottom: 10px;
        border-radius: 4px;
    }
    .update-time {
        font-size: 0.85rem;
        color: #666;
    }
</style>

<div class="scorer-container">
    <div class="row mb-3">
        <div class="col">
            <h2>Match #@Model.MatchNumber Scorer</h2>
            <p class="text-muted">@Model.CourtLocation</p>
        </div>
        <div class="col-auto">
            <a asp-action="Details" asp-route-id="@Model.MatchId" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Details
            </a>
        </div>
    </div>

    <div class="row">
        <!-- Main Scoring Area -->
        <div class="col-lg-9">
            <!-- Team Score Panels -->
            <div class="row mb-4">
                <div class="col-md-5">
                    <div class="team-panel">
                        <div class="team-name" id="homeTeamName">@Model.HomeTeamName</div>
                        <div class="team-score" id="homeScore">0</div>
                        <div>
                            <button class="btn btn-light score-btn" onclick="updateScore('@Model.HomeTeamId', 1)">+</button>
                            <button class="btn btn-outline-light score-btn" onclick="updateScore('@Model.HomeTeamId', -1)">−</button>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 d-flex align-items-center justify-content-center">
                    <h1 class="text-muted">VS</h1>
                </div>
                <div class="col-md-5">
                    <div class="team-panel away-panel">
                        <div class="team-name" id="awayTeamName">@Model.AwayTeamName</div>
                        <div class="team-score" id="awayScore">0</div>
                        <div>
                            <button class="btn btn-light score-btn" onclick="updateScore('@Model.AwayTeamId', 1)">+</button>
                            <button class="btn btn-outline-light score-btn" onclick="updateScore('@Model.AwayTeamId', -1)">−</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center Controls -->
            <div class="center-controls">
                <div class="set-label text-center" id="setLabel">SET 1</div>
                
                <div class="row mb-3">
                    <div class="col-md-4">
                        <button class="btn btn-warning set-control-btn" id="btnPreviousSet" onclick="handleSetAction('RevertToPreviousSet')" disabled>
                            <i class="bi bi-arrow-left"></i> Previous Set
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-danger set-control-btn" id="btnEndSet" onclick="handleSetAction('EndCurrentSet')">
                            <i class="bi bi-stop-circle"></i> End Set
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-success set-control-btn" id="btnNewSet" onclick="handleSetAction('StartNextSet')" style="display:none;">
                            <i class="bi bi-plus-circle"></i> New Set
                        </button>
                    </div>
                </div>

                <!-- Sets Won Display -->
                <div class="sets-won-display">
                    <div>
                        <div id="homeSetsWon">0</div>
                        <small>@Model.HomeTeamName</small>
                    </div>
                    <div class="text-muted fs-3">|</div>
                    <div>
                        <div id="awaySetsWon">0</div>
                        <small>@Model.AwayTeamName</small>
                    </div>
                </div>

                <!-- Set History -->
                <div class="set-history">
                    <h6>Set History</h6>
                    <div id="setHistoryList">
                        <p class="text-muted">No sets completed yet</p>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="quick-actions">
                <h5 class="text-white mb-3">Quick Actions</h5>
                <div class="row">
                    <div class="col-md-3">
                        <button class="btn btn-info quick-action-btn" onclick="handleQuickAction('CallToCourt')">
                            <i class="bi bi-megaphone"></i> Call to Court
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-success quick-action-btn" onclick="handleQuickAction('MatchStarted')" id="btnStartMatch">
                            <i class="bi bi-play-circle"></i> Match Started
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-danger quick-action-btn" onclick="handleQuickAction('MatchEnded')" id="btnEndMatch">
                            <i class="bi bi-stop-circle"></i> Match Ended
                        </button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-warning quick-action-btn" onclick="handleQuickAction('Disputed')">
                            <i class="bi bi-exclamation-triangle"></i> Disputed
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Update Feed Sidebar -->
        <div class="col-lg-3">
            <div class="update-feed">
                <h5 class="mb-3">
                    <i class="bi bi-chat-dots"></i> Live Updates
                </h5>
                <div id="updateFeed">
                    <p class="text-muted">No updates yet</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
    <script>
        const matchId = '@Model.MatchId';
        const homeTeamId = '@Model.HomeTeamId';
        const awayTeamId = '@Model.AwayTeamId';
        let currentSetNumber = @Model.CurrentSetNumber;
        let connection;

        // Initialize match state
        let matchState = {
            homeScore: 0,
            awayScore: 0,
            homeSetsWon: 0,
            awaySetsWon: 0,
            sets: @Html.Raw(Json.Serialize(Model.Sets)),
            isFinished: @Model.IsFinished.ToString().ToLower(),
            currentSetNumber: @Model.CurrentSetNumber
        };

        $(document).ready(function() {
            initializeSignalR();
            loadInitialState();
        });

        function initializeSignalR() {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/scorerhub")
                .withAutomaticReconnect()
                .build();

            // Receive score updates
            connection.on("ReceiveScoreUpdate", function(data) {
                console.log("Score update received:", data);
                updateScoreDisplay(data.setNumber, data.homeScore, data.awayScore);
            });

            // Receive set state changes
            connection.on("ReceiveSetStateChange", function(data) {
                console.log("Set state change received:", data);
                handleSetStateUpdate(data);
            });

            // Receive match state changes
            connection.on("ReceiveMatchStateChange", function(data) {
                console.log("Match state change received:", data);
                handleMatchStateUpdate(data);
            });

            // Receive feed updates
            connection.on("ReceiveFeedUpdate", function(update) {
                console.log("Feed update received:", update);
                addUpdateToFeed(update);
            });

            connection.start()
                .then(() => {
                    console.log("SignalR Connected");
                    connection.invoke("JoinMatchGroup", matchId);
                })
                .catch(err => console.error("SignalR Error:", err));
        }

        function loadInitialState() {
            // Load current set scores
            const currentSet = matchState.sets.find(s => s.setNumber === matchState.currentSetNumber);
            if (currentSet) {
                matchState.homeScore = currentSet.homeTeamScore;
                matchState.awayScore = currentSet.awayTeamScore;
                updateScoreDisplay(matchState.currentSetNumber, matchState.homeScore, matchState.awayScore);
            }

            // Update sets won
            $('#homeSetsWon').text(matchState.homeSetsWon);
            $('#awaySetsWon').text(matchState.awaySetsWon);

            // Update set label
            $('#setLabel').text('SET ' + matchState.currentSetNumber);

            // Update set history
            updateSetHistory();

            // Update button states
            updateButtonStates();
        }

        async function updateScore(teamId, increment) {
            if (matchState.isFinished) {
                alert("Match is finished. Cannot update scores.");
                return;
            }

            try {
                await connection.invoke("SendScoreUpdate", matchId, matchState.currentSetNumber, teamId, increment);
            } catch (err) {
                console.error("Error sending score update:", err);
                alert("Failed to update score. Please try again.");
            }
        }

        function updateScoreDisplay(setNumber, homeScore, awayScore) {
            if (setNumber === matchState.currentSetNumber) {
                matchState.homeScore = homeScore;
                matchState.awayScore = awayScore;
                $('#homeScore').text(homeScore);
                $('#awayScore').text(awayScore);
            }
        }

        async function handleSetAction(actionType) {
            try {
                await connection.invoke("SendSetStateChange", matchId, actionType);
            } catch (err) {
                console.error("Error sending set state change:", err);
                alert("Failed to perform action. Please try again.");
            }
        }

        function handleSetStateUpdate(data) {
            matchState.currentSetNumber = data.currentSetNumber;
            matchState.sets = data.sets;
            matchState.homeSetsWon = data.homeSetsWon;
            matchState.awaySetsWon = data.awaySetsWon;

            // Update display
            $('#setLabel').text('SET ' + data.currentSetNumber);
            $('#homeSetsWon').text(data.homeSetsWon);
            $('#awaySetsWon').text(data.awaySetsWon);

            // Reset current scores for new set
            const currentSet = matchState.sets.find(s => s.setNumber === matchState.currentSetNumber);
            if (currentSet) {
                matchState.homeScore = currentSet.homeTeamScore;
                matchState.awayScore = currentSet.awayTeamScore;
                $('#homeScore').text(matchState.homeScore);
                $('#awayScore').text(matchState.awayScore);
            } else {
                matchState.homeScore = 0;
                matchState.awayScore = 0;
                $('#homeScore').text(0);
                $('#awayScore').text(0);
            }

            updateSetHistory();
            updateButtonStates();
        }

        async function handleQuickAction(actionType) {
            try {
                await connection.invoke("SendQuickAction", matchId, actionType);
            } catch (err) {
                console.error("Error sending quick action:", err);
                alert("Failed to perform action. Please try again.");
            }
        }

        function handleMatchStateUpdate(data) {
            matchState.isFinished = data.isFinished;
            
            if (data.isFinished) {
                $('#btnStartMatch').prop('disabled', true);
                $('#btnEndMatch').prop('disabled', true);
                alert("Match has ended!");
            }

            updateButtonStates();
        }

        function updateSetHistory() {
            const historyHtml = matchState.sets
                .filter(s => s.isFinished)
                .sort((a, b) => a.setNumber - b.setNumber)
                .map(s => `
                    <div class="set-history-item">
                        <strong>Set ${s.setNumber}:</strong> 
                        ${s.homeTeamScore} v ${s.awayTeamScore}
                        ${s.isLocked ? '<span class="badge bg-secondary ms-2">Locked</span>' : ''}
                    </div>
                `).join('');

            $('#setHistoryList').html(historyHtml || '<p class="text-muted">No sets completed yet</p>');
        }

        function updateButtonStates() {
            const currentSet = matchState.sets.find(s => s.setNumber === matchState.currentSetNumber);
            const isCurrentSetFinished = currentSet ? currentSet.isFinished : false;

            // Previous Set button: enabled only if current set is 0-0 AND not first set
            const canRevert = matchState.homeScore === 0 && matchState.awayScore === 0 && matchState.currentSetNumber > 1;
            $('#btnPreviousSet').prop('disabled', !canRevert);

            // End Set button: visible when set is in progress
            if (isCurrentSetFinished) {
                $('#btnEndSet').hide();
                $('#btnNewSet').show();
            } else {
                $('#btnEndSet').show();
                $('#btnNewSet').hide();
            }

            // Disable score buttons if match finished
            if (matchState.isFinished) {
                $('.score-btn').prop('disabled', true);
                $('.set-control-btn').prop('disabled', true);
            }
        }

        function addUpdateToFeed(update) {
            const updateHtml = `
                <div class="update-item">
                    <div class="update-time">${new Date(update.timestamp).toLocaleTimeString()}</div>
                    <div>${update.content}</div>
                    ${update.updateType ? '<small class="badge bg-primary">' + update.updateType + '</small>' : ''}
                </div>
            `;

            $('#updateFeed').prepend(updateHtml);

            // Keep only last 15 updates
            $('.update-item').slice(15).remove();
        }
    </script>
}
