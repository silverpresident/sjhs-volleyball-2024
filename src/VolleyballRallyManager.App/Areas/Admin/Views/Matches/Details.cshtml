@model VolleyballRallyManager.App.Areas.Admin.Models.MatchDetailsViewModel
@using VolleyballRallyManager.Lib.Models

@{
    ViewData["Title"] = "Match Details";
    var match = Model.Match;
}

<div class="container">
    <h1>Match Details</h1>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Match #@match.MatchNumber</h5>
                        @if (match.IsDisputed)
                        {
                            <span class="badge bg-danger">Disputed</span>
                        }
                        else if (match.IsFinished)
                        {
                            <span class="badge bg-success">Finished</span>
                        }
                        else if (match.ActualStartTime.HasValue)
                        {
                            <span class="badge bg-primary">In Progress</span>
                        }
                        else
                        {
                            <span class="badge bg-secondary">Scheduled</span>
                        }
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col">
                            <h6>Round</h6>
                            <p>@match.Round?.Name</p>
                        </div>
                        <div class="col">
                            <h6>Court</h6>
                            <p>@match.CourtLocation</p>
                        </div>
                        <div class="col">
                            <h6>Scheduled Time</h6>
                            <p>@match.ScheduledTime.ToString("dd/MM/yyyy HH:mm")</p>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-5 text-center">
                            <div class="team-box p-3 border rounded">
                                <div class="team-color mb-2"
                                    style="width: 30px; height: 30px; border-radius: 50%; background-color: @match.HomeTeam?.Color; margin: 0 auto;">
                                </div>
                                <h5>@match.HomeTeam?.Name</h5>
                                <small class="text-muted">@match.HomeTeam?.School</small>
                                <h2 class="mt-3">@match.HomeTeamScore</h2>
                                <small class="text-muted">Sets Won</small>
                            </div>
                        </div>
                        <div class="col-md-2 d-flex align-items-center justify-content-center">
                            <h4>VS</h4>
                        </div>
                        <div class="col-md-5 text-center">
                            <div class="team-box p-3 border rounded">
                                <div class="team-color mb-2"
                                    style="width: 30px; height: 30px; border-radius: 50%; background-color: @match.AwayTeam?.Color; margin: 0 auto;">
                                </div>
                                <h5>@match.AwayTeam?.Name</h5>
                                <small class="text-muted">@match.AwayTeam?.School</small>
                                <h2 class="mt-3">@match.AwayTeamScore</h2>
                                <small class="text-muted">Sets Won</small>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6>Referee</h6>
                            <p>@(string.IsNullOrEmpty(match.RefereeName) ? "Not assigned" : match.RefereeName)</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Scorer</h6>
                            <p>@(string.IsNullOrEmpty(match.ScorerName) ? "Not assigned" : match.ScorerName)</p>
                        </div>
                    </div>

                    @if (match.ActualStartTime.HasValue)
                    {
                        <div class="row">
                            <div class="col">
                                <h6>Started At</h6>
                                <p>@match.ActualStartTime.Value.ToString("dd/MM/yyyy HH:mm")</p>
                            </div>
                        </div>
                    }
                </div>
            </div>

            @if (Model.Sets.Any())
            {
        int HomeTotal = 0;
        int AwayTotal = 0;
        @foreach (var set in Model.Sets)
        {
            HomeTotal += set.HomeTeamScore;
            AwayTotal += set.AwayTeamScore;
        }

                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Set History</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Set</th>
                                    <th>@match.HomeTeam?.Name

                                        <span
                                            class="badge @(HomeTotal > AwayTotal ? "bg-success" : "bg-secondary text-dark") fs-6">
                                            @HomeTotal
                                        </span>
                                    </th>
                                    <th>@match.AwayTeam?.Name<span
                                            class="badge @(AwayTotal > HomeTotal ? "bg-success" : "bg-secondary text-dark") fs-6">
                                            @AwayTotal
                                        </span>
                                    </th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var set in Model.Sets.OrderBy(s => s.SetNumber))
                                {
                                    <tr>
                                        <td><strong>Set @set.SetNumber</strong></td>
                                        <td class="@(set.HomeTeamScore > set.AwayTeamScore ? "fw-bold text-success" : "")">
                                            @set.HomeTeamScore</td>
                                        <td class="@(set.AwayTeamScore > set.HomeTeamScore ? "fw-bold text-success" : "")">
                                            @set.AwayTeamScore</td>
                                        <td>
                                            @if (set.IsLocked)
                                            {
                                                <span class="badge bg-secondary">
                                                    <i class="bi bi-lock-fill"></i> Locked
                                                </span>
                                            }
                                            else if (set.IsFinished)
                                            {
                                                <span class="badge bg-success">Finished</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-primary">In Progress</span>
                                            }
                                        </td>
                                        <td>
                                            <a asp-action="EditSet" asp-route-id="@match.Id"
                                                asp-route-setNumber="@set.SetNumber" class="btn btn-sm btn-warning">
                                                <i class="bi bi-pencil"></i> Edit
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            }

            <div class="mb-4">
                <a asp-action="Assign" asp-route-id="@match.Id" class="btn btn-success">
                    <i class="bi bi-calendar-check"></i> Assign Details
                </a>
                <a asp-action="Update" asp-route-id="@match.Id" class="btn btn-warning">
                    <i class="bi bi-chat-left-text"></i> Add Update
                </a>
                <a asp-action="Finalize" asp-route-id="@match.Id" class="btn btn-primary">
                    <i class="bi bi-check-circle"></i> Finalize
                </a>
                <a asp-action="Scorer" asp-route-id="@match.Id" class="btn btn-info">
                    <i class="bi bi-calculator"></i> Scorer Interface
                </a>
                <a asp-action="Edit" asp-route-id="@match.Id" class="btn btn-secondary">
                    <i class="bi bi-pencil"></i> Edit
                </a>
                <a asp-action="Index" class="btn btn-secondary">
                    <i class="bi bi-arrow-left-circle"></i> Back to List
                </a>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Match Updates</h5>
                </div>
                <div class="card-body">
                    <div class="updates-list" style="max-height: 500px; overflow-y: auto;">
                        @if (Model.Updates.Any())
                        {
                            foreach (var update in Model.Updates.OrderByDescending(u => u.CreatedAt))
                            {
                                <div class="update-item mb-3 p-2 border-bottom">
                                    <div class="d-flex justify-content-between">
                                        <small class="text-muted">@update.CreatedAt.ToString("dd/MM HH:mm")</small>
                                        <span class="badge @(update.UpdateType == UpdateType.ScoreUpdate ? "bg-primary" : 
                                                           update.UpdateType == UpdateType.DisputeRaised ? "bg-danger" : 
                                                           "bg-secondary")">
                                            @update.UpdateType
                                        </span>
                                    </div>
                                    <div class="mt-1">@update.Content</div>
                                    @if (!string.IsNullOrEmpty(update.PreviousValue) && !string.IsNullOrEmpty(update.NewValue))
                                    {
                                        <div class="mt-1">
                                            <small class="text-muted">
                                                Changed from @update.PreviousValue to @update.NewValue
                                            </small>
                                        </div>
                                    }
                                    <small class="text-muted">By @update.CreatedBy</small>
                                </div>
                            }
                        }
                        else
                        {
                            <p class="text-muted">No updates for this match.</p>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
