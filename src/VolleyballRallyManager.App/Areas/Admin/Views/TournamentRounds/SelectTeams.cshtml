@model VolleyballRallyManager.App.Areas.Admin.Models.SelectTeamsViewModel

@{
    ViewData["Title"] = "Select Teams";
    var isManualSelection = Model.TeamSelectionStrategy == VolleyballRallyManager.Lib.Models.TeamSelectionStrategy.Manual;
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1><i class="bi bi-people-fill"></i> Select Qualifying Teams</h1>
        <a asp-action="Details" asp-route-id="@Model.TournamentRoundId" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Round
        </a>
    </div>

    <div class="row">
        <!-- LEFT COLUMN: Main Form -->
        <div class="col-lg-9">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="bi bi-trophy"></i> @Model.RoundName - Team Selection</h5>
                </div>
                <div class="card-body">
                    <!-- Display Round Info -->
                    <div class="alert alert-info">
                        <dl class="row mb-0">
                            <dt class="col-sm-4">Round:</dt>
                            <dd class="col-sm-8"><strong>@Model.RoundName</strong></dd>
                            
                            <dt class="col-sm-4">Selection Strategy:</dt>
                            <dd class="col-sm-8">
                                <span class="badge bg-secondary">@Model.TeamSelectionStrategy</span>
                            </dd>
                            
                            <dt class="col-sm-4">Number of Qualifying Teams:</dt>
                            <dd class="col-sm-8"><strong>@Model.NumberOfQualifyingTeams</strong> team(s)</dd>
                        </dl>
                    </div>

                    @if (!isManualSelection)
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-info-circle"></i> <strong>Automatic Selection:</strong> Teams are automatically selected based on the selection strategy. Checkboxes are disabled because the selection is not manual.
                        </div>
                    }

                    <form asp-action="SelectTeams" method="post">
                        <div asp-validation-summary="All" class="alert alert-danger"></div>

                        <input type="hidden" asp-for="TournamentRoundId" />
                        <input type="hidden" asp-for="RoundName" />
                        <input type="hidden" asp-for="TeamSelectionStrategy" />
                        <input type="hidden" asp-for="NumberOfQualifyingTeams" />

                        <!-- TEAMS TABLE -->
                        @if (Model.Teams.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Select</th>
                                            <th>Rank</th>
                                            <th>Team Name</th>
                                            <th>Group</th>
                                            <th>Sets Won</th>
                                            <th>Sets Lost</th>
                                            <th>Points</th>
                                            <th>Point Diff</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @for (int i = 0; i < Model.Teams.Count; i++)
                                        {
                                            var team = Model.Teams[i];
                                            var rowClass = team.IsSelected ? "table-success" : "";
                                            
                                            <tr class="@rowClass">
                                                <td>
                                                    <div class="form-check">
                                                        <input type="hidden" asp-for="Teams[i].TeamId" />
                                                        <input type="hidden" asp-for="Teams[i].TeamName" />
                                                        <input type="hidden" asp-for="Teams[i].Rank" />
                                                        <input type="hidden" asp-for="Teams[i].GroupName" />
                                                        <input type="hidden" asp-for="Teams[i].SetsWon" />
                                                        <input type="hidden" asp-for="Teams[i].SetsLost" />
                                                        <input type="hidden" asp-for="Teams[i].Points" />
                                                        <input type="hidden" asp-for="Teams[i].PointDifference" />
                                                        
                                                        @if (!isManualSelection)
                                                        {
                                                            <input class="form-check-input"
                                                                   type="checkbox"
                                                                   asp-for="Teams[i].IsSelected"
                                                                   id="team_@i"
                                                                   disabled />
                                                        }
                                                        else
                                                        {
                                                            <input class="form-check-input"
                                                                   type="checkbox"
                                                                   asp-for="Teams[i].IsSelected"
                                                                   id="team_@i" />
                                                        }
                                                    </div>
                                                </td>
                                                <td><span class="badge bg-secondary">@team.Rank</span></td>
                                                <td><strong>@team.TeamName</strong></td>
                                                <td>@team.GroupName</td>
                                                <td>@team.SetsWon</td>
                                                <td>@team.SetsLost</td>
                                                <td><strong>@team.Points</strong></td>
                                                <td>
                                                    <span class="@(team.PointDifference > 0 ? "text-success" : team.PointDifference < 0 ? "text-danger" : "")">
                                                        @(team.PointDifference > 0 ? "+" : "")@team.PointDifference
                                                    </span>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> No teams available for selection.
                            </div>
                        }

                        <div class="d-flex justify-content-between mt-4">
                            <a asp-action="Details" asp-route-id="@Model.TournamentRoundId" class="btn btn-secondary">
                                <i class="bi bi-x-circle"></i> Cancel
                            </a>
                            @if (!isManualSelection)
                            {
                                <button type="submit" class="btn btn-primary btn-lg" disabled>
                                    <i class="bi bi-check-circle"></i> Confirm Team Selection
                                </button>
                            }
                            else
                            {
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="bi bi-check-circle"></i> Confirm Team Selection
                                </button>
                            }
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- RIGHT COLUMN: Information -->
        <div class="col-lg-3">
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-info-circle"></i> Team Selection Guide</h5>
                </div>
                <div class="card-body">
                    <p><strong>Selection Strategies:</strong></p>
                    <ul class="small">
                        <li><strong>Top By Points:</strong> Teams are automatically selected based on their points ranking.</li>
                        <li><strong>Winners Only:</strong> Only match winners are selected.</li>
                        <li><strong>Manual:</strong> You can manually select which teams to include.</li>
                    </ul>
                    
                    <p class="small mt-3">
                        <i class="bi bi-lightbulb"></i> <strong>Tip:</strong> Teams with higher ranks and point differences are typically better performers in the round.
                    </p>
                    
                    @if (!isManualSelection)
                    {
                        <div class="alert alert-warning small mt-3">
                            <i class="bi bi-lock"></i> <strong>Automatic Mode:</strong> The selection is based on the configured strategy. You cannot modify the selection unless you change the strategy to 'Manual' in the round settings.
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-success small mt-3">
                            <i class="bi bi-pencil"></i> <strong>Manual Mode:</strong> You can select or deselect teams by clicking the checkboxes.
                        </div>
                    }
                </div>
            </div>

            <div class="card">
                <div class="card-header bg-secondary text-white">
                    <h6 class="mb-0"><i class="bi bi-question-circle"></i> Need Help?</h6>
                </div>
                <div class="card-body small">
                    <p><strong>What happens after selection?</strong></p>
                    <p>The selected teams will be added to the next round of the tournament. You'll be able to generate matches for them in the next step.</p>
                    
                    <p class="mb-0"><strong>Can I change the selection later?</strong></p>
                    <p class="mb-0">Once confirmed, you would need to edit the round settings to change the team selection.</p>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
