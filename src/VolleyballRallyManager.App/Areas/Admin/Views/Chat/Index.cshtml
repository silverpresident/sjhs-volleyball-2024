@model IEnumerable<VolleyballRallyManager.Lib.Models.ChatRoom>
@{
    ViewData["Title"] = "Chat";
    var currentUserId = ViewBag.CurrentUserId as string;
    var currentUserName = ViewBag.CurrentUserName as string;
    var userRoles = ViewBag.UserRoles as IList<string> ?? new List<string>();
}

<div class="container-fluid px-0" id="chat-container">
    <div class="row g-0" style="height: calc(100vh - 100px);">
        <!-- Rooms Sidebar -->
        <div class="col-md-3 border-end" id="rooms-sidebar">
            <div class="d-flex flex-column h-100">
                <!-- Header -->
                <div class="p-3 border-bottom bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-chat-dots"></i> Chat Rooms
                    </h5>
                </div>

                <!-- Create Room Button -->
                <div class="p-2 border-bottom">
                    <button class="btn btn-sm btn-outline-success w-100" id="create-room-btn">
                        <i class="bi bi-plus-circle"></i> Create Room
                    </button>
                </div>

                <!-- Room List -->
                <div class="flex-grow-1 overflow-auto" id="room-list">
                    @foreach (var room in Model)
                    {
                        var icon = room.RoomType switch
                        {
                            VolleyballRallyManager.Lib.Models.ChatRoomType.Public => "bi-globe",
                            VolleyballRallyManager.Lib.Models.ChatRoomType.Private => "bi-lock",
                            VolleyballRallyManager.Lib.Models.ChatRoomType.RoleBased => "bi-people",
                            VolleyballRallyManager.Lib.Models.ChatRoomType.Direct => "bi-person-circle",
                            _ => "bi-chat"
                        };

                        <div class="room-item p-3 border-bottom cursor-pointer" data-room-id="@room.Id" data-room-name="@room.Name" data-room-type="@room.RoomType">
                            <div class="d-flex align-items-center">
                                <i class="bi @icon me-2"></i>
                                <div class="flex-grow-1">
                                    <div class="fw-bold">@room.Name</div>
                                    @if (!string.IsNullOrEmpty(room.Description))
                                    {
                                        <small class="text-muted">@room.Description</small>
                                    }
                                </div>
                                <span class="badge bg-danger ms-2 unread-badge" style="display: none;">0</span>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Chat Area -->
        <div class="col-md-9">
            <div class="d-flex flex-column h-100">
                <!-- Chat Header -->
                <div class="p-3 border-bottom bg-light" id="chat-header">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h5 class="mb-0" id="current-room-name">Select a room</h5>
                            <small class="text-muted" id="current-room-description"></small>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-primary" id="manage-members-btn" style="display: none;">
                                <i class="bi bi-people"></i> Members
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" id="mute-room-btn" style="display: none;">
                                <i class="bi bi-bell-slash"></i> Mute
                            </button>
                            <button class="btn btn-sm btn-outline-danger" id="leave-room-btn" style="display: none;">
                                <i class="bi bi-box-arrow-right"></i> Leave
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Messages Area -->
                <div class="flex-grow-1 overflow-auto p-3" id="messages-area">
                    <div class="text-center text-muted py-5">
                        <i class="bi bi-chat-text display-1"></i>
                        <p>Select a room to start chatting</p>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div class="px-3 py-2" id="typing-indicator" style="display: none;">
                    <small class="text-muted">
                        <i class="bi bi-three-dots"></i>
                        <span id="typing-user-name"></span> is typing...
                    </small>
                </div>

                <!-- Message Input -->
                <div class="p-3 border-top bg-light" id="message-input-area" style="display: none;">
                    <div class="input-group">
                        <input type="text" class="form-control" id="message-input" placeholder="Type a message... (Markdown supported)" autocomplete="off">
                        <button class="btn btn-success" type="button" id="send-btn">
                            <i class="bi bi-send"></i> Send
                        </button>
                    </div>
                    <small class="text-muted">
                        <i class="bi bi-markdown"></i> Markdown supported: **bold**, *italic*, `code`, [link](url)
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Room Modal -->
<div class="modal fade" id="createRoomModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Create New Room</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="create-room-form">
                    <div class="mb-3">
                        <label for="room-name" class="form-label">Room Name</label>
                        <input type="text" class="form-control" id="room-name" required>
                    </div>
                    <div class="mb-3">
                        <label for="room-description" class="form-label">Description (Optional)</label>
                        <input type="text" class="form-control" id="room-description">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="room-private">
                            <label class="form-check-label" for="room-private">
                                Make this room private (Invite only)
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="create-room-confirm">Create Room</button>
            </div>
        </div>
    </div>
</div>

<!-- Manage Members Modal -->
<div class="modal fade" id="manageMembersModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">Manage Room Members</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Current Members List -->
                <div class="mb-4">
                    <h6>Current Members</h6>
                    <div id="current-members-list" class="list-group">
                        <div class="text-center text-muted py-3">
                            <div class="spinner-border spinner-border-sm" role="status"></div>
                            Loading members...
                        </div>
                    </div>
                </div>

                <!-- Add Member Section -->
                <div>
                    <h6>Add Member</h6>
                    <div class="input-group">
                        <select class="form-select" id="user-select">
                            <option value="">Select a user...</option>
                        </select>
                        <button class="btn btn-success" type="button" id="add-member-btn">
                            <i class="bi bi-person-plus"></i> Add
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>
    <script>
        // Configuration
        const currentUserId = '@currentUserId';
        const currentUserName = '@currentUserName';
        const userRoles = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(userRoles));
    </script>
    <link rel="stylesheet" href="~/css/chat.css" asp-append-version="true" />
    <script src="~/js/chat.js" asp-append-version="true"></script>
    <script src="~/js/chat-members.js" asp-append-version="true"></script>
}

